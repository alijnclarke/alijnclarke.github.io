---
layout: post
title: Amazon Weather Station + Grafana = win
date:   2017-01-04 17:12
categories: [weather station, grafana, homelab]
---
#### Introduction
For Christmas I wanted to buy my stepdad a more 'professional' weather station, as for the last couple of years he's been using cheap stations that kept breaking, and didn't report much data. However he isn't amazingly technical, so I had the idea of combining grafana with the station in order to generate some easy to understand but also useful metrics. I was hoping that by choosing a station with a usb port, I'd be able to connect a Pi and periodically pull the data and then fire it into a backing store.

As per usual I'd left this until a few days before Christmas, so had to limit my search of stations to those available with Amazon Prime (and that had a usb port), I ended up with an *Aercus Instruments WS3083* (priced at Â£119 at the time of writing).

> https://www.amazon.co.uk/Weather-Station-Wireless-Internet-Beginners/dp/B00C9MFQ1A/ref=sr_1_9?ie=UTF8&qid=1483548381&sr=8-9&keywords=weather+station

##### Kit List
- Weather station (WS3083)
- Raspberry Pi 2 (though any should work)
- Hardware capable of running the graphing stack (influxDB + grafana)

#### Pi Setup
##### Software Install
I'm going to assume you've got your Pi setup with debian like os and have assigned it a static IP. We need to install a package called *weewx* this bascially interfaces with a range of usb weather stations and allows us to pull data from them, and then send it to various services. Their website is worth a look, as it has a whole range of functions (that we won't be using).

> http://www.weewx.com/

Run the following commands on your Pi, either using sudo or root.

{% highlight bash %}
apt-get update
apt-get install python-configobj
apt-get install python-cheetah
apt-get install python-imaging
apt-get install python-usb
{% endhighlight %}

That prepares all of the neccessary requirements, we can now go ahead and install *weewx*

{% highlight bash %}
wget http://www.weewx.com/downloads/weewx_3.6.2-1_all.deb
dpkg -i weewx_3.6.2-1_all.deb
{% endhighlight %}

This will begin to install *weewx*, eventually it will present an interface, just fill this in with the required data. You just need to make sure that when it asks for your specific weather station you give it the following information.

- station_type = FineOffsetUSB
- model = WH3080

Once it's completed if you run:

{% highlight bash %}
service weewx status
{% endhighlight %}

You'll get a warning about a failure to start due to the weather station not being plugged in, so go ahead and plug the station in to the Pi via usb, then issue the following restart command:

{% highlight bash %}
service weewx restart
service weewx status
{% endhighlight %}

At this point *weewx* will be polling your station every 30m and saving it into the default SQLite database. If you install *apache2* you can view a basic dashboard generated by *weewx* under *http://localhost/weewx* without any config changes.

##### Configure weewx
So now we've got data being collected (confirmed via the apache2 dashboard or a SQLite dump), we need to work out a way of egressing that data to our Grafana (yet to be implemented) system.

The way I chose to acomplish this was by use of a Graphite plugin for *weewx* (graphite can be enabled on the InfluxDB server as a way of recieving data). This plugin is not included by default with *weewx* but is very simple to install.

Issue the following commands in the terminal:

{% highlight bash %}
wget https://github.com/ampledata/weewx_graphite/archive/master.tar.gz
wee_extension --install master.tar.gz
{% endhighlight %}

Now that the plugin is installed, we need to activate it and specificy the location of the Graphite (aka InfluxDB) server, we will assign a static ip to InfluxDB, so we need to make sure that this what we enter.

{% highlight bash %}
cd /etc/weewx/
nano weewx.conf
{% endhighlight %}

Look for the **[StdRESTful]** block and then configure the **Graphite** entry:

{% highlight bash %}
[[Graphite]]
    host = x.x.x.x # IP of influxDB server here
    port = 2003    # leave this as default
{% endhighlight %}


### Please bare with me as this is a work in progress!
